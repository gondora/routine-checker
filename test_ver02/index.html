<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mission System Test - Cloud Sync</title>
    <style>
      /* 既存のスタイルはそのまま使いなさい */
      body {
        font-family: sans-serif;
        text-align: center;
        background: #f0f0f0;
        margin: 0;
        padding: 20px;
      }
      #stats-container {
        background: white;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      .exp-bar-bg {
        width: 100%;
        height: 12px;
        background: #ddd;
        border-radius: 6px;
        overflow: hidden;
        margin-top: 10px;
      }
      #exp-bar-fill {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #4caf50, #8bc34a);
        transition: width 0.5s;
      }
      .task-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      button {
        padding: 10px 20px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      #camera-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 1000;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }
      #camera-preview {
        width: 90%;
        max-width: 400px;
        border: 4px solid #00ff00;
        border-radius: 15px;
        transform: scaleX(-1);
      }
      .countdown {
        color: #00ff00;
        font-size: 2rem;
        font-weight: bold;
        margin-top: 10px;
      }
      #log-gallery {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
        margin-top: 20px;
      }
      .log-item {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 5px;
        border: 2px solid white;
      }
      #status-msg {
        color: #555;
        font-size: 0.8rem;
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <div id="stats-container">
      <div>
        <strong>USER LEVEL: <span id="level-val">1</span></strong>
      </div>
      <div class="exp-bar-bg"><div id="exp-bar-fill"></div></div>
      <small>EXP: <span id="exp-val">0</span> / 100</small>
    </div>

    <div class="task-card">
      <span>朝の薬を飲む（証拠が必要！）</span>
      <button id="mission-btn" onclick="startMission('meds')">ミッション開始</button>
    </div>

    <div id="status-msg"></div>
    <div id="log-gallery"></div>

    <div id="camera-overlay">
      <video id="camera-preview" autoplay playsinline></video>
      <div class="countdown" id="timer">準備はいい？</div>
      <canvas id="shutter-canvas" style="display: none"></canvas>
    </div>

    <script>
      // 【最重要】ここにアンタのウェブアプリURLを貼り付けなさい！
      const GAS_URL = "https://script.google.com/macros/s/XXXXX/exec";

      let exp = parseInt(localStorage.getItem("test_exp") || "0");
      let level = parseInt(localStorage.getItem("test_level") || "1");

      updateUI();

      async function startMission(taskId) {
        const overlay = document.getElementById("camera-overlay");
        const video = document.getElementById("camera-preview");
        const timer = document.getElementById("timer");
        const btn = document.getElementById("mission-btn");

        try {
          const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
          video.srcObject = stream;
          overlay.style.display = "flex";
          btn.disabled = true; // 重複送信防止よ

          let count = 3;
          timer.innerText = count;
          const interval = setInterval(() => {
            count--;
            timer.innerText = count > 0 ? count : "SHUTTER!";
            if (count <= 0) clearInterval(interval);
          }, 1000);

          setTimeout(async () => {
            const dataUrl = capturePhoto(video);

            // ストップ処理を優先
            stream.getTracks().forEach((track) => track.stop());
            overlay.style.display = "none";

            // GAS送信（非同期で裏で走らせるわ）
            sendToCloud(dataUrl, taskId);

            gainExp(34);
            btn.disabled = false;
          }, 3500);
        } catch (err) {
          alert("カメラエラー: " + err);
          btn.disabled = false;
        }
      }

      function capturePhoto(video) {
        const canvas = document.getElementById("shutter-canvas");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext("2d").drawImage(video, 0, 0);

        // 圧縮してBase64化
        const dataUrl = canvas.toDataURL("image/jpeg", 0.5);

        // プレビュー表示
        const img = document.createElement("img");
        img.src = dataUrl;
        img.className = "log-item";
        document.getElementById("log-gallery").prepend(img);

        return dataUrl;
      }

      async function sendToCloud(dataUrl, taskId) {
        const statusMsg = document.getElementById("status-msg");
        statusMsg.innerText = "クラウドに保存中...";

        try {
          // no-corsモードでリクエストを投げるわ
          await fetch(GAS_URL, {
            method: "POST",
            mode: "no-cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              taskId: taskId,
              image: dataUrl,
              timestamp: new Date().toLocaleString(),
            }),
          });
          statusMsg.innerText = "保存完了！ドライブを確認しなさい。";
        } catch (err) {
          console.error(err);
          statusMsg.innerText = "送信エラー。コンソールを見なさい。";
        }
      }

      function gainExp(amount) {
        exp += amount;
        if (exp >= 100) {
          level++;
          exp -= 100;
          alert("LEVEL UP! 脳が進化しているわよ！");
        }
        localStorage.setItem("test_exp", exp);
        localStorage.setItem("test_level", level);
        updateUI();
      }

      function updateUI() {
        document.getElementById("level-val").innerText = level;
        document.getElementById("exp-val").innerText = exp;
        document.getElementById("exp-bar-fill").style.width = exp + "%";
      }
    </script>
  </body>
</html>

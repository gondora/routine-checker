<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mission System Test</title>
    <style>
      body {
        font-family: sans-serif;
        text-align: center;
        background: #f0f0f0;
        margin: 0;
        padding: 20px;
      }
      #stats-container {
        background: white;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      .exp-bar-bg {
        width: 100%;
        height: 12px;
        background: #ddd;
        border-radius: 6px;
        overflow: hidden;
        margin-top: 10px;
      }
      #exp-bar-fill {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #4caf50, #8bc34a);
        transition: width 0.5s;
      }

      .task-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      button {
        padding: 10px 20px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }

      /* カメラオーバーレイ */
      #camera-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 1000;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }
      #camera-preview {
        width: 90%;
        max-width: 400px;
        border: 4px solid #00ff00;
        border-radius: 15px;
        transform: scaleX(-1);
      }
      .countdown {
        color: #00ff00;
        font-size: 2rem;
        font-weight: bold;
        margin-top: 10px;
      }

      /* ログ表示 */
      #log-gallery {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
        margin-top: 20px;
      }
      .log-item {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 5px;
        border: 2px solid white;
      }
    </style>
  </head>
  <body>
    <div id="stats-container">
      <div>
        <strong>USER LEVEL: <span id="level-val">1</span></strong>
      </div>
      <div class="exp-bar-bg"><div id="exp-bar-fill"></div></div>
      <small>EXP: <span id="exp-val">0</span> / 100</small>
    </div>

    <div class="task-card">
      <span>朝の薬を飲む（証拠が必要！）</span>
      <button onclick="startMission('meds')">ミッション開始</button>
    </div>

    <div id="log-gallery"></div>

    <div id="camera-overlay">
      <video id="camera-preview" autoplay playsinline></video>
      <div class="countdown" id="timer">準備はいい？</div>
      <canvas id="shutter-canvas" style="display: none"></canvas>
    </div>

    <script>
      let exp = parseInt(localStorage.getItem("test_exp") || "0");
      let level = parseInt(localStorage.getItem("test_level") || "1");

      // 1. 起動時にステータスを反映
      updateUI();

      async function startMission(taskId) {
        const overlay = document.getElementById("camera-overlay");
        const video = document.getElementById("camera-preview");
        const timer = document.getElementById("timer");

        try {
          const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
          video.srcObject = stream;
          overlay.style.display = "flex";

          // 3秒カウントダウン
          let count = 3;
          timer.innerText = count;
          const interval = setInterval(() => {
            count--;
            timer.innerText = count > 0 ? count : "SHUTTER!";
            if (count <= 0) clearInterval(interval);
          }, 1000);

          // 3.5秒後に撮影
          setTimeout(() => {
            captureAndSave(video, taskId);
            stream.getTracks().forEach((track) => track.stop());
            overlay.style.display = "none";
            gainExp(34); // テスト用に多めの経験値
          }, 3500);
        } catch (err) {
          alert("カメラエラー: " + err);
        }
      }

      function captureAndSave(video, taskId) {
        const canvas = document.getElementById("shutter-canvas");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext("2d").drawImage(video, 0, 0);

        const dataUrl = canvas.toDataURL("image/jpeg", 0.5);

        // ログとして画面に追加（視覚的フィードバック）
        const img = document.createElement("img");
        img.src = dataUrl;
        img.className = "log-item";
        document.getElementById("log-gallery").prepend(img);

        console.log(`Saved task: ${taskId}`);
      }

      function gainExp(amount) {
        exp += amount;
        if (exp >= 100) {
          level++;
          exp -= 100;
          alert("LEVEL UP! 脳が進化しているわよ！");
        }
        localStorage.setItem("test_exp", exp);
        localStorage.setItem("test_level", level);
        updateUI();
      }

      function updateUI() {
        document.getElementById("level-val").innerText = level;
        document.getElementById("exp-val").innerText = exp;
        document.getElementById("exp-bar-fill").style.width = exp + "%";
      }
    </script>
  </body>
</html>
